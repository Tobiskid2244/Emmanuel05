#! /bin/bash

set -e
set -x

if [ "$TRAVIS_REPO_SLUG"  != plumed/plumed2 ] ; then
  echo "Repository $TRAVIS_REPO_SLUG"
  echo "Ignoring plumedbot"
  exit 0
fi

## download the complete history (needed for src/header.sh to work correctly)
git fetch --unshallow

## change user
git config user.email "giovanni.bussi+plumedbot@gmail.com"
git config user.name "plumedbot"

set +x # this is not to show the GIT_TOKEN on Travis log
git remote add plumedbot https://plumedbot:$GIT_TOKEN@github.com/plumedbot/plumed2.git
cat > $HOME/.config/hub << EOF
github.com:
- user: plumedbot
  oauth_token: $GIT_TOKEN
  protocol: https
EOF
set -x

hash=$( git log -1 --format="%h")
branch=plumedbot-$TRAVIS_BRANCH-$hash

git checkout -b $branch

changes=false

make astyle

cat > commit-$branch  << EOF
Plumedbot commit: astyle

This commit contains changes automatically generated by plumedbot on Travis-ci.
EOF

if git commit -F commit-$branch
then
  changes=true
fi

cd src && ./header.sh && cd -

cat > commit-$branch  << EOF
Plumedbot commit: headers

This commit contains changes automatically generated by plumedbot on Travis-ci.
EOF

if git commit -F commit-$branch
then
  changes=true
fi

if [ "$changes" = true ] ; then

echo "Pushing to plumedbot"

# -q and 2> is not to show the GIT_TOKEN on Travis log
git push -q -f plumedbot $branch 2> /dev/null 

cat > pull-request-$branch << EOF
This pull request contains changes automatically generated by plumedbot on Travis-ci.
Please review them and, if correct, merge them to branch $TRAVIS_BRANCH.
EOF

hub pull-request -F pull-request-$branch -h plumedbot/plumed2:$branch -b plumed/plumed2:$TRAVIS_BRANCH

fi

git remote remove plumedbot

#Revert all changes
git checkout $hash


