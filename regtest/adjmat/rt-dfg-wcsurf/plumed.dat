# Calculate contact matrix
c1_mat: CONTACT_MATRIX GROUP=1-512 SWITCH={EXP D_0=4.0 R_0=0.5 D_MAX=6.0}
# Calculate coordination numbers
c1: COORDINATIONNUMBER WEIGHT=c1_mat.w 
# Select coordination numbers that are more than 2.0
cf: MORE_THAN ARG1=c1 SWITCH={RATIONAL D_0=2.0 R_0=0.1} 
# Build a dot product matrix
c1_mat2: CONTACT_MATRIX GROUP=1-512 SWITCH={EXP D_0=4.0 R_0=0.5 D_MAX=6.0}
dp_mat: DOTPRODUCT_MATRIX GROUP1=cf 
# Build the final matrix
mat: MATHEVAL ARG1=c1_mat2.w ARG2=dp_mat FUNC=x*y PERIODIC=NO
# Find largest cluster
dfs: DFSCLUSTERING MATRIX=mat 
clust1: CLUSTER_PROPERTIES CLUSTERS=dfs CLUSTER=1 
nat: CLUSTER_NATOMS CLUSTERS=dfs CLUSTER=1

# Print out the size of the cluster and the atoms
PRINT ARG=nat FILE=colvar
PRINT ATOMS=c1 ARG1=cf ARG2=c1 FILE=myatoms.xyz FMT=%8.4f

# Find center of largest cluster
trans1: MATHEVAL ARG1=cf ARG2=clust1 FUNC=x*x*y PERIODIC=NO 
cent: CENTER ATOMS=1-512 WEIGHTS=trans1 PHASES

# Dumpmulticolvar with origin at center 
PRINT ATOMS=c1 ARG1=clust1 FILE=multicolvar.xyz GREATER_THAN_OR_EQUAL=0.001 UNITS=A FMT=%8.4f ORIGIN=cent
 
# Calculate the density of the dnesity of the multicolvar
dens_dist: DISTANCES ORIGIN=cent ATOMS=c1 COMPONENTS 
dens_numer: KDE HEIGHTS=trans1 ARG1=dens_dist.x ARG2=dens_dist.y ARG3=dens_dist.z GRID_BIN=30,30,30 BANDWIDTH=2.0,2.0,2.0 UNORMALIZED
dens_denom: KDE HEIGHTS=clust1 ARG1=dens_dist.x ARG2=dens_dist.y ARG3=dens_dist.z GRID_BIN=30,30,30 BANDWIDTH=2.0,2.0,2.0 UNORMALIZED
dens: MATHEVAL ARG1=dens_numer ARG2=dens_denom FUNC=x/y PERIODIC=NO

# Print the cube and find a contour
PRINT ARG=dens FILE=dens.grid FMT=%8.4f STRIDE=1
sc: FIND_SPHERICAL_CONTOUR ARG=dens CONTOUR=0.85 INNER_RADIUS=10.0 OUTER_RADIUS=40.0 NPOINTS=100
PRINT ARG=sc FILE=mysurface.xyz UNITS=A FMT=%8.4f STRIDE=1 
